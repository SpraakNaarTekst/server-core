/*Copyright Spraak naar Tekst*/
function e(e,t){return e.buckets[t]}function t(e){var t=[];for(var n in e){var i=e[n];i.types.subscriber&&t.push(i)}return t}function n(e){var t=[];for(var n in e){var i=e[n];i.types.subscriber&&i.isAuthenticated()&&t.push(i)}return t}function i(e,t,n){for(var i in e){var o=e[i];if(d(n.bucket.recipients)||-1!==n.bucket.recipients.indexOf(o.socket.id)){var s=JSON.parse(JSON.stringify(n));delete s.bucket.recipients,o.types.subscriber&&("message"==t&&o.messages.push(s),o.socket.emit(t,s))}}}function o(e,t,n){for(var i in e){var o=e[i];o.types.publisher&&o.socket.emit(t,n)}}function s(e,t,n){for(var i in e){var o=e[i];"message"==t&&o.messages.push(n),o.socket.emit(t,n)}}function r(e,t){var n=0;for(var i in e){var o=e[i];o.types.subscriber&&(o.types.debug&&!t||n++)}return n}function a(e,t){var n=0;for(var i in e){var o=e[i];o.types.publisher&&(o.types.debug&&!t||n++)}return n}function c(e){var t=new Date,n=t.getFullYear(),i=t.getMonth()+1,o=t.getDate(),s=t.getHours(),r=t.getMinutes(),a=t.getSeconds();u("./logs/",function(t){if(t)f.log("Couldn't write log files because logs directory could not be created");else try{p.writeFileSync("./logs/"+n+"-"+i+"-"+o+"-"+s+"-"+r+"-"+a+"_"+e.socket.id+".log",k(e,null,2))}catch(e){f.log("Couldn't write log files because something unexpected happened",e)}})}function u(e,t,n){"function"==typeof t&&(n=t,t=511),l(e,t,function(e){n(e?"EEXIST"==e.code?null:e:null)})}function d(e){return!e||0==e.length||1==e.length&&""==e[0]}var p=require("fs"),l=require("mkdirp"),g=require("./connectionUtil.js"),f=require("./logger.js"),k=require("json-stringify-safe");module.exports={authenticateLocation:function(e,t,n,i,s){"string"==typeof i&&(i=JSON.parse(i));var r=i.username,a=i.password;g.login(r,a,function(i,r){if(i)return f.log("location authentication failed while logging in!",i),t.socket.emit("event",{eventType:"locationAuthenticationFailed"}),void s("error");g.getProfile(r.accessToken,function(i,a){if(i)return f.log("location authentication failed while getting profile information!",i,r),t.socket.emit("event",{eventType:"locationAuthenticationFailed"}),n.locationAuthentication=null,void s("error");g.getLocationsWhereUserIsOwner(r.accessToken,a._id,function(e,i){if(e)return f.log("location authentication failed!",e),t.socket.emit("event",{eventType:"locationAuthenticationFailed"}),n.locationAuthentication=null,void s("error");if(!i||!i.length)return f.log("location authentication failed!","the logged in user is not an owner of any Location"),t.socket.emit("event",{eventType:"locationAuthenticationFailed"}),n.locationAuthentication=null,void s("error");var o=i[0];n.locationAuthentication={locationId:o._id,locationName:o.name,locationOwnerIds:o.ownerIds,accessToken:r.accessToken,user:a},f.log("location authenticated!",o),t.socket.emit("event",{eventType:"locationAuthenticationSuccessful",location:{id:o._id,name:o.name}}),s(null,"success")}),o(e,"event",{eventType:"socketAuthenticatedAsLocation",who:{socketid:t.socket.id,ipaddress:t.socket.conn.remoteAddress}})})})},storeConfiguration:function(e){p.writeFileSync("./config.js","module.exports = "+k(e,null,4))},authenticateClient:function(e,t,n,i){"string"==typeof i&&(i=JSON.parse(i));var s=i.username,r=i.password;g.login(s,r,function(i,s){if(i)return f.log("authentication failed!"),void t.socket.emit("event",{eventType:"authenticationFailed"});g.getProfile(s.accessToken,function(i,r){if(i)return f.log("authentication failed!"),t.socket.emit("event",{eventType:"authenticationFailed"}),void(t.clientAuthentication=null);var a={subscriber:!0,publisher:!0,locationOwner:-1!==n.locationAuthentication.locationOwnerIds.indexOf(r._id)},c={id:n.locationAuthentication.locationId,name:n.locationAuthentication.locationName};t.clientAuthentication={accessToken:s.accessToken,user:r},t.socket.emit("event",{eventType:"authenticationSuccessful",token:s.accessToken,location:c,roles:a,user:r}),o(e,"event",{eventType:"socketAuthenticated",who:{socketid:t.socket.id,ipaddress:t.socket.conn.remoteAddress}})})})},notifyConnectionThatWeRequireLocationAuthentication:function(e){f.log("location authentication is required!"),e.socket.emit("event",{eventType:"locationAuthenticationRequired"})},tellOthersAboutSocketConnect:function(e,t){s(e,"event",{eventType:"socketConnected",who:{socketid:t.socket.id,ipaddress:t.socket.conn.remoteAddress}}),s(e,"information",{informationType:"subscriberCount",count:r(e)}),s(e,"information",{informationType:"publisherCount",count:a(e)})},sendAllMessagesFromSpecificConnection:function(e,t,n){"string"==typeof t&&(t=JSON.parse(t));var i={messages:e[t.who.socketid].buckets,who:t.who};n.emit("all messages",i)},createTranscriptForPublishersIfTheyDontAlreadyHaveOne:function(e,t,n){for(var i in n){var o=n[i];o.types.publisher&&!o.transcript._id&&module.exports.createTranscript(e,t,o)}},createTranscript:function(e,t,n){function i(){n.transcript._id=null,n.transcript.locationId=t,n.transcript.status="In Progress",g.createRecord(e,"transcript",n.transcript,function(e,t){e?n.createMijnSpraakNaarTranscriptResult="failed":(n.createMijnSpraakNaarTranscriptResult="success, transcript has id: "+t._id,n.transcript._id=t._id)})}n.transcript._id?module.exports.finishTranscript(e,n,function(){i()}):i()},finishTranscript:function(e,t){t.transcript.status="Completed",f.log("Finishing transcript",t.transcript),g.updateRecord(e,"transcript",t.transcript,function(e,n){e?t.finishedMijnSpraakNaarTranscriptResult="failed":(t.finishedMijnSpraakNaarTranscriptResult="success, done",t.transcript._id=null)})},sendDisconnectEvent:function(e,t,n){s(e,"event",{eventType:"socketDisconnected",who:{socketid:t.id,ipaddress:t.conn.remoteAddress,preferredTranscriptLanguage:n}})},sendSocketRegisteredTypeEventToPublishers:function(e,t,n,i){o(e,"event",{eventType:"socketRegisteredAsType",type:n,who:{socketid:t.id,ipaddress:t.conn.remoteAddress,preferredTranscriptLanguage:i}})},sendSocketRegisteredTypeEventToPublisherForAllExistingSubscribers:function(e,n){var i=[n],o=t(e);for(var s in o){var r=o[s];if(r.isAuthenticated()){var a=r.clientAuthentication.user.preferredLanguage;module.exports.sendSocketRegisteredTypeEventToPublishers(i,r.socket,"subscriber",a)}}},logConnection:function(e){c(e)},removeConnectionFromList:function(e,t){delete e[t.socket.id]},sendSubscriberCountAndPublisherCountToAll:function(e){s(e,"information",{informationType:"subscriberCount",count:r(e)}),s(e,"information",{informationType:"publisherCount",count:a(e)})},storeMessageInBucket:function(e,t,n,i){if(t.messages.push(i),"upsert"==i.action){t.buckets[i.bucketId]||(t.buckets[i.bucketId]={transcriptId:t.transcript._id,bucketId:i.bucketId,order:i.bucketId,snippetSourceLanguage:i.snippetSourceLanguage,recipients:i.recipients});var o=t.buckets[i.bucketId];if(i.snippetSourceLanguage&&(o.snippetSourceLanguage=i.snippetSourceLanguage),i.snippetsByTargetLanguage){o.snippetsByTargetLanguage||(o.snippetsByTargetLanguage={});for(var s in i.snippetsByTargetLanguage){var r=i.snippetsByTargetLanguage[s];o.snippetsByTargetLanguage[s]||(o.snippetsByTargetLanguage[s]={}),r.snippet&&(o.snippetsByTargetLanguage[s].snippet=r.snippet)}}n.who={socketid:t.socket.id,ipaddress:t.socket.conn.remoteAddress},n.lastMessage={id:i.bucketId,message:i.snippet},f.log("upserted message",o)}else"delete"==i.action&&(o=t.buckets[i.bucketId])&&(i.snippetTargetLanguage&&i.snippetSourceLanguage==i.snippetTargetLanguage?delete t.buckets[i.bucketId]:delete o.snippetsByTargetLanguage[i.snippetTargetLanguage])},sendBucketToSubscribers:function(t,n,o){i(t,"message",{action:"upsert",bucketId:o,bucket:e(n,o)})},sendBucketToMijnSpraakNaarTekst:function(t,n,i){var o=e(n,i),s=JSON.parse(JSON.stringify(o));delete s.recipients,s._id?g.updateRecord(t,"transcriptBucket",s,function(e,t){}):g.createRecord(t,"transcriptBucket",s,function(e,t){e?f.log("error while inserting bucket",e):t&&(o._id=t._id)})},sendLastMessage:function(e,t,n,i){if(i.who){var o,s,r=e[i.who.socketid].buckets;for(var a in r)o=a,s=r[a];c={who:i.who,lastMessage:{id:o,message:s}}}else var c=n;t.emit("last message",c)},sendEventFromSocketToAll:function(e,t,n){n.who={socketid:t.id,ipaddress:t.conn.remoteAddress},s(e,"event",n)},ensureFolderExists:function(e,t,n){u(e,t,n)}};