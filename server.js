/*Copyright Spraak naar Tekst*/
var e=require("fs");e.existsSync("./config.js")||e.writeFileSync("./config.js",e.readFileSync("./config_base.js"));var t=require("./config.js"),n=require("crypto"),i=require("os"),o=require("socket.io"),s=o(t.port),c=require("diont")({broadcast:!1}),r=require("htmlencode").htmlEncode,a=require("./serverUtil.js"),u=require("./connectionUtil.js"),l=require("./logger.js"),s=function(){function e(e,n){t.locationAuthentication&&t.locationAuthentication.accessToken?n():a.notifyConnectionThatWeRequireLocationAuthentication(e)}function n(){var e=i.networkInterfaces(),t=[];for(var n in e)e[n].forEach(function(e){"IPv4"==e.family&&!1===e.internal&&t.push(e.address)});return t}var o={},r={who:{socketid:null,ipaddress:null},lastMessage:{id:null,message:null}};try{s.on("connection",function(n){var i;l.log("A socket connected over socket.io: ",n.id),o[n.id]={types:{},socket:n,messages:[],buckets:{},isAuthenticated:function(){return this.clientAuthentication&&this.clientAuthentication.accessToken&&this.clientAuthentication.user},clientAuthentication:{accessToken:null,user:null},transcript:{_id:null,locationId:null,status:null},createMijnSpraakNaarTranscriptResult:null,finishedMijnSpraakNaarTranscriptResult:null},i=o[n.id],a.tellOthersAboutSocketConnect(o,i),n.on("disconnect",function(){l.log("A socket disconnected. Socket id is:",n.id),l.log("The types are: ",i.types);try{i.types.publisher&&a.finishTranscript(t.locationAuthentication.accessToken,i);var e;i.types.subscriber&&i.isAuthenticated()&&(l.log("The user is: ",i.clientAuthentication.user),e=i.clientAuthentication.user.preferredLanguage),a.sendDisconnectEvent(o,i.socket,e),t&&t.writeLogs&&a.logConnection(i),a.removeConnectionFromList(o,i),a.sendSubscriberCountAndPublisherCountToAll(o)}catch(e){l.log("something went wrong while processing the disconnect of socket "+i.socket.id),l.log("error is",e)}}),n.on("register type",function(s){l.log("Socket "+n.id+" registered itself as type",s),i.types[s]=!0,"publisher"==s&&(e(i,function(){a.createTranscript(t.locationAuthentication.accessToken,t.locationAuthentication.locationId,i)}),a.sendSocketRegisteredTypeEventToPublisherForAllExistingSubscribers(o,i)),a.sendSubscriberCountAndPublisherCountToAll(o);var c;"subscriber"==s&&i.isAuthenticated()&&(c=i.clientAuthentication.user.preferredLanguage),a.sendSocketRegisteredTypeEventToPublishers(o,i.socket,s,c)}),n.on("message",function(n){e(i,function(){"string"==typeof n&&(n=JSON.parse(n)),i.types.publisher&&(a.storeMessageInBucket(o,i,r,n),"upsert"==n.action?(a.sendBucketToSubscribers(o,i,n.bucketId),a.sendBucketToMijnSpraakNaarTekst(t.locationAuthentication.accessToken,i,n.bucketId)):n.action)})}),n.on("request all messages",function(e){a.sendAllMessages(o,e,n)}),n.on("request last message",function(e){"string"==typeof e&&(e=JSON.parse(e)),a.sendLastMessage(o,i.socket,r,e)}),n.on("event",function(s){"string"==typeof s&&(s=JSON.parse(s)),i.types.publisher&&("startTranscript"==s.eventType&&(i.transcript._id||e(i,function(){a.createTranscript(t.locationAuthentication.accessToken,t.locationAuthentication.locationId,i)})),"finalizeTranscript"==s.eventType&&a.finishTranscript(t.locationAuthentication.accessToken,i)),a.sendEventFromSocketToAll(o,n,s)}),n.on("authenticate",function(e){t.locationAuthentication&&t.locationAuthentication.accessToken?a.authenticateClient(o,i,t,e):a.authenticateLocation(o,i,t,e,function(e,n){e||(a.storeConfiguration(t),a.createTranscriptForPublishersIfTheyDontAlreadyHaveOne(t.locationAuthentication.accessToken,t.locationAuthentication.locationId,o))})}),n.on("ping",function(e){n.emit("pong",e)})})}catch(e){l.log("something went wrong during the processing of a connection")}var u=n();for(var d in u)l.log("Preekondertiteling Server Core is running at http://"+u[d]+":"+t.port);var h=c.announceService({name:"Preekondertiteling Server Core",port:t.port});h?l.log("Preekondertiteling Server Core is broadcasting its location via Diont using UDP Multicast. Id is ",h):l.log("Preekondertiteling Server Core failed to broadcast its location via Diont using UDP Multicast."),setInterval(function(){c.repeatAnnouncements()},5e3)}();module.exports=s;