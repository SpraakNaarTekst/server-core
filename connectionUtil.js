/*Copyright Spraak naar Tekst*/
function e(e){return e?e.responseJSON||e.responseText||e||"error":"error"}function o(e){var o=function(){},n=function(){},e={baseUrl:"http://"+i.centralServerConfig.host+":"+i.centralServerConfig.port,method:e.method,headers:e.headers||{},url:e.url,body:e.data},a={done:function(e){return o=e,a},fail:function(e){return n=e,a}};return setTimeout(function(){if(i.centralServerConfig.useMocks){var a=!1;for(var u in l){var c=l[u];if(c.pattern.test(e.url)&&e.method==c.method){a=!0;var d=c.returnBody();if(d&&"string"==typeof d)try{d=JSON.parse(d)}catch(e){r.log(e)}200==c.returnCode?(r.log("mocking call for "+e.method+" "+e.url),r.log(d),o(d)):(r.log("mocking failed for "+e.method+" "+e.url),r.log(d),n(d));break}}a||(r.log("mock not found for "+e.url),n("Could not find mock"))}else try{e.body&&(e.json=!0);t(e,function(t,i,l){if(l&&"string"==typeof l)try{l=JSON.parse(l)}catch(e){r.log(e)}t||200!=i.statusCode?(r.log("Got fail! for "+e.method+" "+e.url),r.log(l||t),n(l||t)):(r.log("Got OK! for "+e.method+" "+e.url),r.log(l),o(l))})}catch(e){n(e)}},1),a}var n=require("http"),t=require("request"),r=require("./logger.js"),i=require("./config.js"),l=require("./mocks.js").mocks,a={};a.getAccessTokenFromSession=function(e){return e.accessToken},a.storeAccessTokenInSession=function(e,o){o.accessToken=e},a.deleteAccessTokenFromSession=function(e){delete e.accessToken},a.login=function(n,t,r){o({url:"/auth/token",method:"POST",data:{email:n,password:t}}).done(function(e){r(null,e)}).fail(function(o){r(e(o),null)})},a.getProfile=function(n,t){o({url:"/profile",method:"GET",headers:{Authorization:"Bearer "+n}}).done(function(e){t(null,e)}).fail(function(o){t(e(o),null)})},a.getLocationsWhereUserIsOwner=function(e,o,n){a.getLocations(e,function(e,t){if(e)n(e,null);else{if(t&&t.length)for(var r=t.length-1;r>=0;)t[r].ownerIds&&t[r].ownerIds.length&&-1!==t[r].ownerIds.indexOf(o)||t.splice(r,1),r--;n(null,t)}})},a.getLocations=function(n,t){o({url:"/data/location/",method:"GET",headers:{Authorization:"Bearer "+n}}).done(function(e){t(null,e)}).fail(function(o){t(e(o),null)})},a.getMetadata=function(n,t,r){var i={};n&&(i.Authorization="Bearer "+n),o({url:"/metadata/"+t,method:"GET",headers:i}).done(function(e){delete e._id,delete e.__v,r(null,e)}).fail(function(o){r(e(o),null)})},a.getRecords=function(n,t,r,i){var l={};n&&(l.Authorization="Bearer "+n),o({url:"/data/"+t,method:"GET",headers:l}).done(function(e){i(null,e)}).fail(function(o){i(e(o),null)})},a.logout=function(n,t){o({url:"/auth/revoke",method:"POST",data:{access_token:n}}).done(function(e){t(null,!0)}).fail(function(o){t(e(o),!1)})},a.createRecord=function(n,t,i,l){var a={"Content-Type":"application/json"};n&&(a.Authorization="Bearer "+n),o({url:"/data/"+t+"/",method:"POST",headers:a,data:i}).done(function(e){r.log("creating worked!"),l(null,e)}).fail(function(o){r.log("creating did not work!"),l(e(o),null)})},a.updateRecord=function(n,t,i,l){r.log("Updating ",i);var a={"Content-Type":"application/json"};n&&(a.Authorization="Bearer "+n),o({url:"/data/"+t+"/"+i._id,method:"PUT",headers:a,data:i}).done(function(e){r.log("updating worked!"),l(null,e)}).fail(function(o){r.log("updating did not work!"),l(e(o),null)})},a.deleteRecord=function(n,t,r,i){var l={};n&&(l.Authorization="Bearer "+n),o({url:"/data/"+t+"/"+r,method:"DELETE",headers:l}).done(function(e){i(null,e)}).fail(function(o){i(e(o),null)})},module.exports=a;